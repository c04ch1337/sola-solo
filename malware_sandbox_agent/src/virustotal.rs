//! VirusTotal API Client
//!
//! Provides integration with VirusTotal's public API v2 for malware scanning.
//! API documentation: https://developers.virustotal.com/reference/overview

use anyhow::Result;
use serde::{Deserialize, Serialize};
use std::collections::HashMap;
use std::time::Duration;

/// VirusTotal API client
pub struct VirusTotalClient {
    api_key: String,
    client: reqwest::Client,
    base_url: String,
}

impl VirusTotalClient {
    /// Create a new VirusTotal client
    pub fn new(api_key: String) -> Self {
        let client = reqwest::Client::builder()
            .timeout(Duration::from_secs(60))
            .build()
            .expect("Failed to create HTTP client");

        Self {
            api_key,
            client,
            base_url: "https://www.virustotal.com/vtapi/v2".to_string(),
        }
    }

    /// Scan a file
    pub async fn scan_file(&self, file_data: &[u8], filename: &str) -> Result<VirusTotalResult> {
        // Step 1: Upload file for scanning
        let form = reqwest::multipart::Form::new()
            .text("apikey", self.api_key.clone())
            .part(
                "file",
                reqwest::multipart::Part::bytes(file_data.to_vec())
                    .file_name(filename.to_string()),
            );

        let upload_response: UploadResponse = self
            .client
            .post(format!("{}/file/scan", self.base_url))
            .multipart(form)
            .send()
            .await?
            .json()
            .await?;

        // Step 2: Poll for results (with retries)
        let mut retries = 0;
        let max_retries = 10;

        loop {
            tokio::time::sleep(Duration::from_secs(15)).await;

            let report_response: ReportResponse = self
                .client
                .post(format!("{}/file/report", self.base_url))
                .form(&[
                    ("apikey", self.api_key.as_str()),
                    ("resource", &upload_response.resource),
                ])
                .send()
                .await?
                .json()
                .await?;

            if report_response.response_code == 1 {
                // Analysis complete
                return Ok(VirusTotalResult {
                    scan_id: upload_response.scan_id,
                    resource: upload_response.resource,
                    sha256: report_response.sha256.unwrap_or_default(),
                    md5: report_response.md5.unwrap_or_default(),
                    positives: report_response.positives,
                    total: report_response.total,
                    scan_date: report_response.scan_date.unwrap_or_default(),
                    permalink: report_response.permalink.unwrap_or_default(),
                    scans: report_response.scans,
                });
            } else if report_response.response_code == -2 {
                // Still queued/analyzing
                retries += 1;
                if retries >= max_retries {
                    return Err(anyhow::anyhow!("Timeout waiting for VirusTotal analysis"));
                }
                continue;
            } else {
                return Err(anyhow::anyhow!(
                    "VirusTotal API error: {}",
                    report_response.verbose_msg.unwrap_or_else(|| "Unknown error".to_string())
                ));
            }
        }
    }

    /// Get file report by hash
    pub async fn get_file_report(&self, hash: &str) -> Result<Option<VirusTotalResult>> {
        let report_response: ReportResponse = self
            .client
            .post(format!("{}/file/report", self.base_url))
            .form(&[("apikey", self.api_key.as_str()), ("resource", hash)])
            .send()
            .await?
            .json()
            .await?;

        if report_response.response_code == 1 {
            Ok(Some(VirusTotalResult {
                scan_id: report_response.scan_id.unwrap_or_default(),
                resource: hash.to_string(),
                sha256: report_response.sha256.unwrap_or_default(),
                md5: report_response.md5.unwrap_or_default(),
                positives: report_response.positives,
                total: report_response.total,
                scan_date: report_response.scan_date.unwrap_or_default(),
                permalink: report_response.permalink.unwrap_or_default(),
                scans: report_response.scans,
            }))
        } else {
            Ok(None)
        }
    }

    /// Rescan a file by hash
    pub async fn rescan_file(&self, hash: &str) -> Result<String> {
        let response: RescanResponse = self
            .client
            .post(format!("{}/file/rescan", self.base_url))
            .form(&[("apikey", self.api_key.as_str()), ("resource", hash)])
            .send()
            .await?
            .json()
            .await?;

        Ok(response.scan_id)
    }
}

/// VirusTotal scan result
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct VirusTotalResult {
    pub scan_id: String,
    pub resource: String,
    pub sha256: String,
    pub md5: String,
    pub positives: u32,
    pub total: u32,
    pub scan_date: String,
    pub permalink: String,
    pub scans: HashMap<String, ScanResult>,
}

/// Individual antivirus scan result
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ScanResult {
    pub detected: bool,
    pub version: Option<String>,
    pub result: Option<String>,
    pub update: Option<String>,
}

/// Upload response from VirusTotal
#[derive(Debug, Deserialize)]
struct UploadResponse {
    response_code: i32,
    verbose_msg: String,
    resource: String,
    scan_id: String,
    permalink: String,
}

/// Report response from VirusTotal
#[derive(Debug, Deserialize)]
struct ReportResponse {
    response_code: i32,
    verbose_msg: Option<String>,
    resource: Option<String>,
    scan_id: Option<String>,
    sha256: Option<String>,
    md5: Option<String>,
    positives: u32,
    total: u32,
    scan_date: Option<String>,
    permalink: Option<String>,
    scans: HashMap<String, ScanResult>,
}

/// Rescan response from VirusTotal
#[derive(Debug, Deserialize)]
struct RescanResponse {
    response_code: i32,
    resource: String,
    scan_id: String,
    permalink: String,
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_virustotal_client_creation() {
        let client = VirusTotalClient::new("test_api_key".to_string());
        assert_eq!(client.api_key, "test_api_key");
    }
}
